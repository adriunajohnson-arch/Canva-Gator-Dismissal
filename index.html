<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WCMS Bus Dismissal Board â€” Cloud Sync</title>
<style>
:root{--bg:#344e41;--panel:#3a5a40;--btn:#588157;--accent:#a3b18a;--text:#dad7cd;--bd:#274033;--tile:#2f4639}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#2f4639;border-bottom:1px solid var(--bd)}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.chip{padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#2c4437;opacity:.95;font-size:12px}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
@media (max-width:900px){.layout{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:0 8px 24px #0005}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
.bus{position:relative;background:var(--tile);border:1px solid var(--bd);border-radius:14px;padding:24px 14px;text-align:center;font-weight:900;font-size:32px}
.inline-btn{position:absolute;top:8px;right:8px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--bd);background:var(--panel);color:var(--text);cursor:pointer}
.departed-item{background:var(--tile);border:1px solid var(--bd);border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;justify-content:space-between}
input{background:#263b30;color:var(--text);border:1px solid var(--bd);border-radius:12px;padding:10px 12px;outline:none;min-width:260px}
button{cursor:pointer;font-weight:800;border-radius:12px;padding:10px 14px;border:1px solid var(--bd);background:var(--btn);color:var(--text)}
button.secondary{background:var(--accent);color:#263326}
.muted{opacity:.85;font-size:12px}
.hidden{display:none}

/* Full-screen sound gate */
#soundGate{
  position:fixed;inset:0;z-index:1000;background:linear-gradient(180deg,#2b3f34 0%,#344e41 100%);
  display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;
  padding:24px;cursor:pointer;transition:opacity .25s ease;
}
#soundGate.hidden{opacity:0;pointer-events:none}
#soundGate .card{
  background:#263b30;border:1px solid var(--bd);border-radius:16px;max-width:560px;width:min(92%,560px);
  padding:24px 20px;box-shadow:0 12px 40px #0007;
}
#soundGate h1{margin:0 0 8px 0;font-size:26px}
#soundGate p{margin:6px 0 14px 0;opacity:.95}
#soundGate .tapHint{opacity:.8;font-size:13px}
#soundGate .gateBtn{
  margin-top:12px;padding:12px 16px;border-radius:12px;border:1px solid var(--bd);
  background:var(--btn);color:var(--text);font-weight:900;font-size:16px;
}
</style>
</head>
<body>
<!-- Sound gate overlay -->
<div id="soundGate" role="button" aria-label="Tap to enable announcements">
  <div class="card">
    <h1>ðŸ”Š Enable Bus Announcements</h1>
    <p>This page will chime and read numbers aloud. Tap to allow sound on this device.</p>
    <button class="gateBtn" id="gateBtn">Enable Sound</button>
    <div class="tapHint">Tip: Youâ€™ll only need to do this once per device per day.</div>
  </div>
</div>

<header>
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 13h18v3a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5v-3Z" stroke="#a3b18a" stroke-width="1.5"/><path d="M5 9.5h14a2 2 0 0 1 2 2V13H3v-1.5a2 2 0 0 1 2-2Z" fill="#2f4639" stroke="#a3b18a" stroke-width="1.5"/><circle cx="7" cy="18.5" r="1.7" fill="#a3b18a"/><circle cx="17" cy="18.5" r="1.7" fill="#a3b18a"/></svg>
    <span>WCMS Bus Dismissal Board</span>
  </div>
  <div class="row">
    <span id="syncBadge" class="chip">Sync: Cloud</span>
    <span id="adminStatus" class="chip">Viewer</span>
    <button id="adminLoginBtn" class="secondary">Admin Login</button>
  </div>
</header>

<div class="container">
  <div id="adminPanel" class="panel hidden" aria-live="polite">
    <div class="row" style="justify-content:space-between;width:100%">
      <strong>Admin Controls</strong>
      <div class="row">
        <span id="sessionTimeLeft" class="chip">Admin: --</span>
        <button id="lockBtn">Lock Now</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="busInput" placeholder="Type entries separated by commas (e.g., 102, Car & Van, 62/65, A/B)" />
      <button id="addBtn">Add to Board</button>
      <button id="clearAllBtn">Clear All</button>
    </div>
    <div class="muted">Accepts words & symbols (/, &, -). Newest on top. Chime + voice on add & depart.</div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Now Boarding</h2>
        <span class="muted" id="liveMeta">Cloud Firestore</span>
      </div>
      <div id="board" class="grid" aria-live="assertive"></div>
    </div>
    <aside class="panel" aria-live="polite">
      <h3 style="margin:0 0 8px 0">Departed</h3>
      <div id="departedList"></div>
    </aside>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
/* ---------------- Firebase Config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAOFY5GUONFgaorwLfaCE7imj5NbN0NN0U",
  authDomain: "wcms-bus-board.firebaseapp.com",
  projectId: "wcms-bus-board",
  storageBucket: "wcms-bus-board.firebasestorage.app",
  messagingSenderId: "302977263459",
  appId: "1:302977263459:web:cd3aaf4a1ff3fca36b1556",
  measurementId: "G-TP5DSZS0X2"
};
let db=null;
try{ const app=firebase.initializeApp(firebaseConfig); db=firebase.firestore(); }
catch(e){ console.error("Firebase init failed:", e); alert("Couldn't connect to Firebase."); }

/* ---------------- Audio + Speech ---------------- */
let audioEnabled=false,preferredVoice=null,audioCtx=null;
function getVoicesSafe(){try{const v=window.speechSynthesis?window.speechSynthesis.getVoices():[];return Array.isArray(v)?v:[];}catch{return[];}}
function pickVoice(){const voices=getVoicesSafe();const prefs=["en-US","en_US","en-GB","en_GB"];let best=null;for(const p of prefs){const f=voices.find(v=>(v.lang||"").toLowerCase()===p.toLowerCase());if(f){best=f;break;}}preferredVoice=best||voices[0]||null;}
function waitForVoices(t=3000){return new Promise(r=>{if(!('speechSynthesis'in window))return r(false);if(getVoicesSafe().length)return r(true);let done=false;const timer=setTimeout(()=>{if(!done){done=true;r(getVoicesSafe().length>0);}},t);window.speechSynthesis.onvoiceschanged=()=>{if(done)return;done=true;clearTimeout(timer);r(getVoicesSafe().length>0);};});}
function primeSpeech(){if(!('speechSynthesis'in window))return;try{window.speechSynthesis.cancel();window.speechSynthesis.resume();const u=new SpeechSynthesisUtterance(" ");u.volume=0;u.lang="en-US";if(preferredVoice)u.voice=preferredVoice;window.speechSynthesis.speak(u);}catch{}}
async function enableSoundNow(){const gate=document.getElementById('soundGate');if(gate){gate.classList.add('hidden');setTimeout(()=>{gate.style.display='none';},260);}try{audioEnabled=true;const Ctx=window.AudioContext||window.webkitAudioContext;if(Ctx&&!audioCtx)audioCtx=new Ctx();if(audioCtx&&audioCtx.state==='suspended'){await audioCtx.resume();}await waitForVoices(2500);pickVoice();primeSpeech();}catch(e){console.error(e);}}
document.getElementById('soundGate').addEventListener('click',enableSoundNow);
document.getElementById('gateBtn').addEventListener('click',e=>{e.stopPropagation();enableSoundNow();});
function speakify(label){let t=String(label);t=t.replace(/\//g,' slash ').replace(/&/g,' and ').replace(/-/g,' dash ').replace(/\+/g,' plus ');return t.replace(/\s+/g,' ').trim();}
async function chime(f1,f2,v,d){if(!audioEnabled)return;try{const Ctx=window.AudioContext||window.webkitAudioContext;if(!audioCtx&&Ctx)audioCtx=new Ctx();if(!audioCtx)return;if(audioCtx.state==='suspended'){await audioCtx.resume();}const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator(),g=audioCtx.createGain();o1.type='triangle';o2.type='sine';o1.frequency.setValueAtTime(f1,audioCtx.currentTime);o2.frequency.setValueAtTime(f2,audioCtx.currentTime);g.gain.setValueAtTime(0.0001,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(v,audioCtx.currentTime+0.03);g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+d);o1.connect(g);o2.connect(g);g.connect(audioCtx.destination);o1.start();o2.start();o1.stop(audioCtx.currentTime+d);o2.stop(audioCtx.currentTime+d);}catch{}}
function chimeArrival(){chime(1046.5,1568.0,1.0,1.5);}
function chimeDepart(){chime(659.25,440.0,0.9,0.8);}
function speak(text){if(!audioEnabled||!('speechSynthesis'in window))return;try{window.speechSynthesis.cancel();window.speechSynthesis.resume();const u=new SpeechSynthesisUtterance(text);u.lang='en-US';if(preferredVoice)u.voice=preferredVoice;setTimeout(()=>{window.speechSynthesis.speak(u);},10);}catch{}}

/* ---------------- Admin Controls ---------------- */
var PASSCODE='1234';
var adminPanel=document.getElementById('adminPanel'),adminStatus=document.getElementById('adminStatus'),
adminLoginBtn=document.getElementById('adminLoginBtn'),lockBtn=document.getElementById('lockBtn'),
sessionTimeLeft=document.getElementById('sessionTimeLeft');
function isAdmin(){var v=localStorage.getItem('bus_admin_until');return v&&Number(v)>Date.now();}
function setAdminFor1Hour(){var until=Date.now()+3600000;localStorage.setItem('bus_admin_until',String(until));updateAdminUI();}
function clearAdmin(){localStorage.removeItem('bus_admin_until');updateAdminUI();}
function updateAdminUI(){var a=isAdmin();adminPanel.classList.toggle('hidden',!a);adminLoginBtn.classList.toggle('hidden',a);adminStatus.textContent=a?'Admin':'Viewer';}
adminLoginBtn.addEventListener('click',async()=>{const email=prompt('Admin email:');if(!email)return;const pass=prompt('Password:');if(!pass)return;try{await firebase.auth().signInWithEmailAndPassword(email,pass);setAdminFor1Hour();alert('Admin unlocked.');}catch(e){alert('Sign-in failed: '+(e&&e.message?e.message:e));}});
lockBtn&&lockBtn.addEventListener('click',clearAdmin);
setInterval(()=>{var v=localStorage.getItem('bus_admin_until');if(!v){sessionTimeLeft.textContent='Locked';return;}var ms=Number(v)-Date.now();if(ms<=0){clearAdmin();sessionTimeLeft.textContent='Locked';return;}var m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000);sessionTimeLeft.textContent='Admin: '+m+'m '+s+'s';},1000);
updateAdminUI();
if(firebase&&firebase.auth){firebase.auth().onAuthStateChanged(u=>{if(u&&u.email){adminStatus.textContent='Admin ('+u.email+')';}else{adminStatus.textContent='Viewer';}});}

/* ---------------- Firestore Collections ---------------- */
const ACTIVE='wcms_bus_board',DEPARTED='wcms_bus_departed';
var board=document.getElementById('board'),departedList=document.getElementById('departedList'),
busInput=document.getElementById('busInput'),addBtn=document.getElementById('addBtn'),
clearAllBtn=document.getElementById('clearAllBtn'),liveMeta=document.getElementById('liveMeta');

function makeActiveTile(id,label){const w=document.createElement('div');w.className='bus';const b=document.createElement('button');b.className='inline-btn';b.setAttribute('data-doc',id);b.setAttribute('data-label',encodeURIComponent(label));b.textContent='Remove';w.appendChild(b);w.appendChild(document.createTextNode(label));return w;}
function renderActive(items){board.innerHTML='';items.forEach(it=>board.appendChild(makeActiveTile(it.id,it.display)));}
function renderDeparted(items){departedList.innerHTML='';items.forEach(n=>{const e=document.createElement('div');e.className='departed-item';e.textContent=n;departedList.appendChild(e);});}

if(db){
 db.collection(ACTIVE).onSnapshot(snap=>{
  liveMeta.textContent='Cloud Firestore Â· '+snap.size+' entries';
  const list=snap.docs.map(d=>({id:d.id,display:(d.data().number??d.id),orderMs:(d.data().orderMs??0)}));
  list.sort((a,b)=>b.orderMs-a.orderMs);renderActive(list);
  snap.docChanges().filter(c=>c.type==='added').forEach(c=>{const s=speakify(c.doc.data().number??c.doc.id);chimeArrival();setTimeout(()=>speak('Bus '+s+' now boarding'),200);});
 });
 db.collection(DEPARTED).onSnapshot(snap=>{
  const list=snap.docs.map(d=>({display:(d.data().number??d.id),orderMs:(d.data().departOrderMs??0)}));
  list.sort((a,b)=>b.orderMs-a.orderMs);renderDeparted(list.map(x=>x.display));
  snap.docChanges().filter(c=>c.type==='added').forEach(c=>{const s=speakify(c.doc.data().number??c.doc.id);chimeDepart();setTimeout(()=>speak('Bus '+s+' has departed'),120);});
 });
}

function tokenize(i){return String(i||'').split(',').map(s=>s.trim()).filter(Boolean);}
function toKey(s){return s.trim().toLowerCase();}
async function addFromStringCloud(str){const
