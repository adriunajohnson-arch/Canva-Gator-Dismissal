<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WCMS Bus Dismissal Board — Demo (Local Only)</title>
  <style>
    /* Palette: #dad7cd, #a3b18a, #588157, #3a5a40, #344e41 */
    :root{
      --bg:#344e41; --panel:#3a5a40; --btn:#588157; --accent:#a3b18a; --text:#dad7cd;
      --panel-border:#274033; --tile:#2f4639;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#2f4639;border-bottom:1px solid var(--panel-border)}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .chip{padding:4px 8px;border-radius:999px;border:1px solid var(--panel-border);background:#2c4437;opacity:.95;font-size:12px}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width: 900px){ .layout{grid-template-columns:1fr} }
    .panel{background:var(--panel);border:1px solid var(--panel-border);border-radius:16px;padding:14px;box-shadow:0 8px 24px #0005}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
    .bus{position:relative;background:var(--tile);border:1px solid var(--panel-border);border-radius:14px;padding:24px 14px;text-align:center;font-weight:900;font-size:36px}
    .inline-btn{position:absolute;top:8px;right:8px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--panel-border);background:var(--panel);color:var(--text);cursor:pointer}
    .departed-item{background:var(--tile);border:1px solid var(--panel-border);border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;justify-content:space-between}
    input{background:#263b30;color:var(--text);border:1px solid var(--panel-border);border-radius:12px;padding:10px 12px;outline:none;min-width:220px}
    button{cursor:pointer;font-weight:800;border-radius:12px;padding:10px 14px;border:1px solid var(--panel-border);background:var(--btn);color:var(--text)}
    button.secondary{background:var(--accent);color:#263326}
    .muted{opacity:.85;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M3 13h18v3a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5v-3Z" stroke="#a3b18a" stroke-width="1.5"/>
        <path d="M5 9.5h14a2 2 0 0 1 2 2V13H3v-1.5a2 2 0 0 1 2-2Z" fill="#2f4639" stroke="#a3b18a" stroke-width="1.5"/>
        <circle cx="7" cy="18.5" r="1.7" fill="#a3b18a"/>
        <circle cx="17" cy="18.5" r="1.7" fill="#a3b18a"/>
      </svg>
      <span>WCMS Bus Dismissal Board</span>
    </div>
    <div class="row">
      <span id="mode" class="chip">Demo Mode — Local Only</span>
      <span id="adminStatus" class="chip">Viewer</span>
    </div>
  </header>

  <div class="container">
    <!-- Admin Gate -->
    <div id="pinPanel" class="panel">
      <div class="row">
        <strong>Enter Passcode to Manage Buses</strong>
        <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Passcode (1234)" />
        <button id="unlockBtn" class="secondary">Unlock (1 hour)</button>
      </div>
      <div class="muted">Teachers can open the page to view. Only Admin can add/remove.</div>
    </div>

    <!-- Admin Controls -->
    <div id="adminPanel" class="panel" style="display:none" aria-live="polite">
      <div class="row" style="justify-content:space-between;width:100%">
        <strong>Admin Controls</strong>
        <div class="row">
          <span id="sessionTimeLeft" class="chip">Admin: --</span>
          <button id="lockBtn">Lock Now</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="busInput" placeholder="Type 102, 17, 45A… then press Space, Comma, or Enter" />
        <button id="addBtn">Add to Board</button>
        <button id="clearAllBtn">Clear All</button>
      </div>
      <div class="muted">Duplicates ignored · Auto-announce on add/remove · Instant add with space/comma/Enter</div>
    </div>

    <div class="layout">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">Now Boarding</h2>
          <span class="muted" id="liveMeta">Local Storage</span>
        </div>
        <div id="board" class="grid" aria-live="assertive"></div>
      </div>
      <aside class="panel" aria-live="polite">
        <h3 style="margin:0 0 8px 0">Departed</h3>
        <div id="departedList"></div>
      </aside>
    </div>
  </div>

  <script>
    // ----- Safe JSON helpers -----
    function jget(key, fallback){
      try { var v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
    }

    // ----- Audio + TTS -----
    var soundEnabled = true;
    function playChime(){
      if(!soundEnabled) return;
      try{
        var Ctx = window.AudioContext || window.webkitAudioContext; if(!Ctx) return;
        var ctx = new Ctx();
        var o = ctx.createOscillator(); var g = ctx.createGain();
        o.type = 'triangle'; o.frequency.value = 880;
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.7);
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime+0.7);
      }catch(e){}
    }
    function speak(text){
      try{ if('speechSynthesis' in window){ var u = new SpeechSynthesisUtterance(text); u.rate=1.0; u.pitch=1.05; u.lang='en-US'; speechSynthesis.speak(u); } }catch(e){}
    }

    // ----- Admin (PIN 1234) -----
    var PASSCODE = '1234';
    var adminPanel = document.getElementById('adminPanel');
    var pinPanel   = document.getElementById('pinPanel');
    var pinInput   = document.getElementById('pinInput');
    var unlockBtn  = document.getElementById('unlockBtn');
    var lockBtn    = document.getElementById('lockBtn');
    var adminStatus= document.getElementById('adminStatus');
    var sessionTimeLeft = document.getElementById('sessionTimeLeft');

    function isAdmin(){ var v = localStorage.getItem('bus_admin_until'); return v && Number(v) > Date.now(); }
    function setAdminFor1Hour(){ var until = Date.now()+3600000; localStorage.setItem('bus_admin_until', String(until)); updateAdminUI(); }
    function clearAdmin(){ localStorage.removeItem('bus_admin_until'); updateAdminUI(); }
    function updateAdminUI(){ var a=isAdmin(); adminPanel.style.display = a ? '' : 'none'; pinPanel.style.display = a ? 'none' : ''; adminStatus.textContent = a ? 'Admin' : 'Viewer'; }

    unlockBtn.addEventListener('click', function(){ if(pinInput.value===PASSCODE){ setAdminFor1Hour(); } else { alert('Incorrect passcode.'); } });
    lockBtn.addEventListener('click', clearAdmin);

    setInterval(function(){
      var v = localStorage.getItem('bus_admin_until');
      if(!v){ sessionTimeLeft.textContent='Locked'; return; }
      var ms = Number(v)-Date.now(); if(ms<=0){ clearAdmin(); sessionTimeLeft.textContent='Locked'; return; }
      var m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
      sessionTimeLeft.textContent = 'Admin: '+m+'m '+s+'s left';
    }, 1000);

    updateAdminUI();

    // ----- Data (Local Only) -----
    var KA='buses', KD='departed';
    function getA(){ return jget(KA, []); }
    function setA(v){ localStorage.setItem(KA, JSON.stringify(v)); }
    function getD(){ return jget(KD, []); }
    function setD(v){ localStorage.setItem(KD, JSON.stringify(v)); }

    // ----- UI Elements -----
    var board = document.getElementById('board');
    var departedList = document.getElementById('departedList');
    var busInput = document.getElementById('busInput');
    var addBtn = document.getElementById('addBtn');
    var clearAllBtn = document.getElementById('clearAllBtn');

    function renderActive(){
      var buses = getA().slice();
      buses.sort(function(a,b){ return a.localeCompare(b, 'en', {numeric:true}); });
      board.innerHTML = '';
      for(var i=0;i<buses.length;i++){
        var b = buses[i];
        var d = document.createElement('div');
        d.className = 'bus';
        d.innerHTML = '<button class="inline-btn" data-id="'+b+'">Remove</button>'+b;
        board.appendChild(d);
      }
    }
    function renderDeparted(){
      var dep = getD();
      departedList.innerHTML = '';
      for(var i=0;i<dep.length;i++){
        var n = dep[i];
        var e = document.createElement('div'); e.className='departed-item'; e.textContent=n; departedList.appendChild(e);
      }
    }
    function renderAll(){ renderActive(); renderDeparted(); }

    function sanitize(t){ return t.replace(/[^0-9a-zA-Z]/g,'').toUpperCase(); }
    function addFromString(str){
      if(!str) return 0;
      var raw = str.split(/[ ,]+/);
      var tokens = [];
      for(var i=0;i<raw.length;i++){ var tok = sanitize(raw[i]); if(tok) tokens.push(tok); }
      if(tokens.length===0) return 0;
      var list = getA();
      var set = {}; for(i=0;i<list.length;i++){ set[list[i].toUpperCase()] = true; }
      var added = 0;
      for(i=0;i<tokens.length;i++){ var n = tokens[i]; if(!set[n]){ list.push(n); set[n]=true; added++; } }
      if(added>0){ setA(list); try{ playChime(); speak('Bus '+tokens.join(', ')+' is now boarding'); }catch(e){} renderActive(); }
      return added;
    }

    addBtn.addEventListener('click', function(){ if(!isAdmin()) return alert('Unlock admin first'); if(addFromString(busInput.value)>0) busInput.value=''; });
    busInput.addEventListener('keydown', function(e){ if(!isAdmin()) return; if(e.key==='Enter'||e.key===','||e.key===' '){ e.preventDefault(); if(addFromString(busInput.value)>0) busInput.value=''; } });
    busInput.addEventListener('input', function(){ if(!isAdmin()) return; var v=busInput.value; if(/[ ,]$/.test(v) && v.trim().length>0){ if(addFromString(v)>0) busInput.value=''; } });

    document.addEventListener('click', function(e){
      var t = e.target; var id = t && t.getAttribute('data-id'); if(!id) return;
      if(!isAdmin()) return alert('Unlock admin first');
      var a = getA().filter(function(x){ return x!==id; }); setA(a);
      var d = getD(); d.unshift(id); setD(d);
      try{ playChime(); speak('Bus '+id+' has departed'); }catch(e){}
      renderAll();
    });

    function clearAllData(){
      try{ localStorage.removeItem(KA); }catch(e){}
      try{ localStorage.removeItem(KD); }catch(e){}
      renderAll();
    }
    clearAllBtn.addEventListener('click', function(){ if(!isAdmin()) return alert('Unlock admin first'); if(confirm('Clear all buses and departed?')){ clearAllData(); } });

    // Initial paint and cross-tab updates
    renderAll();
    window.addEventListener('storage', function(e){ if(e.key===KA||e.key===KD) renderAll(); });
  </script>
</body>
</html>
