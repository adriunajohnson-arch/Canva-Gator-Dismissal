<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WCMS Bus Dismissal Board — Cloud Sync</title>
<style>
:root{--bg:#344e41;--panel:#3a5a40;--btn:#588157;--accent:#a3b18a;--text:#dad7cd;--bd:#274033;--tile:#2f4639}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#2f4639;border-bottom:1px solid var(--bd)}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.chip{padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#2c4437;opacity:.95;font-size:12px}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
@media (max-width:900px){.layout{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:0 8px 24px #0005}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
.bus{position:relative;background:var(--tile);border:1px solid var(--bd);border-radius:14px;padding:24px 14px;text-align:center;font-weight:900;font-size:32px}
.inline-btn{position:absolute;top:8px;right:8px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--bd);background:var(--panel);color:var(--text);cursor:pointer}
.departed-item{background:var(--tile);border:1px solid var(--bd);border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;justify-content:space-between}
input{background:#263b30;color:var(--text);border:1px solid var(--bd);border-radius:12px;padding:10px 12px;outline:none;min-width:260px}
button{cursor:pointer;font-weight:800;border-radius:12px;padding:10px 14px;border:1px solid var(--bd);background:var(--btn);color:var(--text)}
button.secondary{background:var(--accent);color:#263326}
.muted{opacity:.85;font-size:12px}
.hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 13h18v3a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5v-3Z" stroke="#a3b18a" stroke-width="1.5"/><path d="M5 9.5h14a2 2 0 0 1 2 2V13H3v-1.5a2 2 0 0 1 2-2Z" fill="#2f4639" stroke="#a3b18a" stroke-width="1.5"/><circle cx="7" cy="18.5" r="1.7" fill="#a3b18a"/><circle cx="17" cy="18.5" r="1.7" fill="#a3b18a"/></svg>
    <span>WCMS Bus Dismissal Board</span>
  </div>
  <div class="row">
    <span id="syncBadge" class="chip">Sync: Cloud</span>
    <span id="adminStatus" class="chip">Viewer</span>
    <button id="adminLoginBtn" class="secondary">Admin Login</button>
  </div>
</header>

<div class="container">
  <!-- Admin Controls -->
  <div id="adminPanel" class="panel hidden" aria-live="polite">
    <div class="row" style="justify-content:space-between;width:100%">
      <strong>Admin Controls</strong>
      <div class="row">
        <span id="sessionTimeLeft" class="chip">Admin: --</span>
        <button id="lockBtn">Lock Now</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="busInput" placeholder="Type entries separated by commas (e.g., 102, Car & Van, 62/65, A/B). Press Enter or Comma to add." />
      <button id="addBtn">Add to Board</button>
      <button id="clearAllBtn">Clear All</button>
    </div>
    <div class="muted">Accepts words & symbols (/, &, -). Newest on top. Enter/comma to add. Crisp chime + voice on add & depart.</div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Now Boarding</h2>
        <span class="muted" id="liveMeta">Cloud Firestore</span>
      </div>
      <div id="board" class="grid" aria-live="assertive"></div>
    </div>
    <aside class="panel" aria-live="polite">
      <h3 style="margin:0 0 8px 0">Departed</h3>
      <div id="departedList"></div>
    </aside>
  </div>
</div>

<!-- Firebase (Compat SDK) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/* ---------------- Firebase Config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyAOFY5GUONFgaorwLfaCE7imj5NbN0NN0U",
  authDomain: "wcms-bus-board.firebaseapp.com",
  projectId: "wcms-bus-board",
  storageBucket: "wcms-bus-board.firebasestorage.app",
  messagingSenderId: "302977263459",
  appId: "1:302977263459:web:cd3aaf4a1ff3fca36b1556",
  measurementId: "G-TP5DSZS0X2"
};

/* ---------------- App Init ---------------- */
let db=null;
try{ const app=firebase.initializeApp(firebaseConfig); db=firebase.firestore(); }
catch(e){ console.error("Firebase init failed:", e); alert("Couldn't connect to Firebase. Check your config."); }

/* ---------------- Audio & Speech helpers ---------------- */
let audioWarmed = false;
function warmAudioOnce(){
  if(audioWarmed) return;
  audioWarmed = true;
  try{
    if('speechSynthesis' in window){ speechSynthesis.cancel(); speechSynthesis.resume(); }
  }catch(e){}
}
['click','touchstart','keydown'].forEach(evt=> window.addEventListener(evt, warmAudioOnce, {once:true}));

// Speak-friendly mapping (62/65 -> "62 slash 65")
function speakify(label){
  let t = String(label);
  t = t.replace(/\//g, ' slash ');
  t = t.replace(/&/g, ' and ');
  t = t.replace(/-/g, ' dash ');
  t = t.replace(/\+/g, ' plus ');
  t = t.replace(/\s+/g, ' ').trim();
  return t;
}

// CRISP chimes
function chime(freq1,freq2,vol,dur){
  try{
    var Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return;
    var ctx=new Ctx(); var o1=ctx.createOscillator(), o2=ctx.createOscillator(); var g=ctx.createGain();
    o1.type='triangle'; o2.type='sine';
    o1.frequency.value=freq1; o2.frequency.value=freq2;
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(vol, ctx.currentTime+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+dur);
    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    o1.start(); o2.start(); o1.stop(ctx.currentTime+dur); o2.stop(ctx.currentTime+dur);
  }catch(e){}
}
function chimeArrival(){ chime(1046.5,1568.0,1.0,1.5); } // C6 + G6
function chimeDepart(){  chime(659.25, 440.0,0.9,0.8); } // E5 + A4

function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.rate=1.0; u.pitch=1.0; u.lang='en-US';
    speechSynthesis.cancel(); // prevent overlaps
    speechSynthesis.resume(); // iOS/Safari quirk
    speechSynthesis.speak(u);
  }catch(e){}
}

/* ---------------- Admin (PIN 1234) ---------------- */
var PASSCODE='1234';
var adminPanel=document.getElementById('adminPanel');
var adminStatus=document.getElementById('adminStatus');
var adminLoginBtn=document.getElementById('adminLoginBtn');
var lockBtn=document.getElementById('lockBtn');
var sessionTimeLeft=document.getElementById('sessionTimeLeft');

function isAdmin(){ var v=localStorage.getItem('bus_admin_until'); return v && Number(v)>Date.now(); }
function setAdminFor1Hour(){ var until=Date.now()+3600000; localStorage.setItem('bus_admin_until', String(until)); updateAdminUI(); }
function clearAdmin(){ localStorage.removeItem('bus_admin_until'); updateAdminUI(); }
function updateAdminUI(){
  var a=isAdmin();
  adminPanel.classList.toggle('hidden', !a);
  adminLoginBtn.classList.toggle('hidden', a);
  adminStatus.textContent = a ? 'Admin' : 'Viewer';
}
adminLoginBtn.addEventListener('click', function(){
  warmAudioOnce();
  var p=prompt('Enter passcode'); if(p===PASSCODE){ setAdminFor1Hour(); } else if(p!==null){ alert('Incorrect passcode.'); }
});
lockBtn && lockBtn.addEventListener('click', clearAdmin);
setInterval(function(){
  var v=localStorage.getItem('bus_admin_until');
  if(!v){ sessionTimeLeft.textContent='Locked'; return; }
  var ms=Number(v)-Date.now();
  if(ms<=0){ clearAdmin(); sessionTimeLeft.textContent='Locked'; return; }
  var m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000);
  sessionTimeLeft.textContent='Admin: '+m+'m '+s+'s left';
},1000);
updateAdminUI();

/* ---------------- Firestore Collections ---------------- */
const ACTIVE='wcms_bus_board';
const DEPARTED='wcms_bus_departed';

/* ---------------- UI Elements ---------------- */
var board=document.getElementById('board');
var departedList=document.getElementById('departedList');
var busInput=document.getElementById('busInput');
var addBtn=document.getElementById('addBtn');
var clearAllBtn=document.getElementById('clearAllBtn');
var liveMeta=document.getElementById('liveMeta');

/* Build tiles with real doc IDs so removal is bulletproof */
function makeActiveTile(id, label){
  const wrap=document.createElement('div');
  wrap.className='bus';
  const btn=document.createElement('button');
  btn.className='inline-btn';
  btn.setAttribute('data-doc', id);                   // exact Firestore doc id
  btn.setAttribute('data-label', encodeURIComponent(label)); // nice fallback
  btn.textContent='Remove';
  wrap.appendChild(btn);
  wrap.appendChild(document.createTextNode(label));   // displays symbols correctly
  return wrap;
}
function renderActive(items){ // items: [{id, display}]
  board.innerHTML='';
  items.forEach(it=> board.appendChild(makeActiveTile(it.id, it.display)));
}
function renderDeparted(items){
  departedList.innerHTML='';
  items.forEach(n=>{
    const e=document.createElement('div');
    e.className='departed-item';
    e.textContent=n;
    departedList.appendChild(e);
  });
}

/* ---------------- Strict newest-on-top ordering ---------------- */
let activeLoaded=false, departedLoaded=false;

if(db){
  db.collection(ACTIVE).onSnapshot(function(snap){
    liveMeta.textContent='Cloud Firestore · '+snap.size+' entries';

    const list = snap.docs.map(d=>{
      const data=d.data()||{};
      return {
        id: d.id,
        display: data.number ?? d.id,
        orderMs: typeof data.orderMs==='number' ? data.orderMs : 0,
        ts: data.createdAt?.toMillis ? data.createdAt.toMillis() : 0,
        cs: typeof data.createdAtClient==='number' ? data.createdAtClient : 0
      };
    });

    list.sort((a,b)=> (b.orderMs - a.orderMs) || (b.ts - a.ts) || (b.cs - a.cs));
    renderActive(list.map(x=>({id:x.id, display:x.display})));

    if(!activeLoaded){ activeLoaded=true; return; }
    const added = snap.docChanges()
      .filter(c=>c.type==='added')
      .map(c=> (c.doc.data().number ?? c.doc.id));
    if(added.length){
      // play chime then speak after a small delay
      const spoken = added.map(speakify).join(', ');
      chimeArrival();
      setTimeout(()=> speak('Bus ' + spoken + ' is now boarding'), 200);
    }
  });

  db.collection(DEPARTED).onSnapshot(function(snap){
    const list = snap.docs.map(d=>{
      const data=d.data()||{};
      return {
        display: data.number || d.id,
        orderMs: typeof data.departOrderMs==='number' ? data.departOrderMs : 0,
        ts: data.departedAt?.toMillis ? data.departedAt.toMillis() : 0,
        cs: typeof data.departedAtClient==='number' ? data.departedAtClient : 0
      };
    });
    list.sort((a,b)=> (b.orderMs - a.orderMs) || (b.ts - a.ts) || (b.cs - a.cs));
    renderDeparted(list.map(x=>x.display));

    if(!departedLoaded){ departedLoaded=true; return; }
    const added = snap.docChanges()
      .filter(c=>c.type==='added')
      .map(c=> (c.doc.data().number || c.doc.id));
    if(added.length){
      const spoken = added.map(speakify).join(', ');
      chimeDepart();
      setTimeout(()=> speak('Bus ' + spoken + ' has departed'), 120);
    }
  });
}

/* ---------------- Mutations ---------------- */
// Split ONLY on commas; keep &, /, -, spaces, words exactly.
function tokenize(input){
  return String(input||'').split(',').map(s=>s.trim()).filter(Boolean);
}
function toKey(s){ return s.trim().toLowerCase(); }

async function addFromStringCloud(str){
  const tokens = tokenize(str);
  if(!tokens.length) return;

  const ops = [];
  let base = Date.now();
  for(let i=0;i<tokens.length;i++){
    const display = tokens[i];
    const key = toKey(display);
    const snap = await db.collection(ACTIVE).where('numberLower','==',key).limit(1).get();
    if(snap.empty){
      const orderMs = base + i; // strictly increasing for batch
      ops.push(
        db.collection(ACTIVE).add({
          number: display,
          numberLower: key,
          orderMs,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAtClient: orderMs
        })
      );
    }
  }
  if(ops.length){
    try{ await Promise.all(ops); }catch(e){ console.error('Add failed',e); alert('Add failed. Check permissions.'); }
  }
  busInput.value='';
}

async function departByDocId(docId){
  try{ await db.collection(ACTIVE).doc(docId).delete(); }
  catch(e){ console.error('Delete by docId failed', e); throw e; }
}

async function departByLookup(label){
  const key = toKey(label);
  // Try by normalized field
  let qs = await db.collection(ACTIVE).where('numberLower','==',key).limit(5).get();
  if(qs.empty){
    // Try exact display label
    qs = await db.collection(ACTIVE).where('number','==',label).limit(5).get();
  }
  const ops=[];
  qs.forEach(d=> ops.push(db.collection(ACTIVE).doc(d.id).delete()));
  if(ops.length) await Promise.all(ops);
  else {
    // Legacy: a doc id literally equal to the label (e.g., "62/65")
    try{ await db.collection(ACTIVE).doc(label).delete(); }catch(e){}
  }
}

function clearAllCloud(){
  function deleteAll(coll){
    return db.collection(coll).get().then(function(q){
      const ops=[]; q.forEach(d=> ops.push(db.collection(coll).doc(d.id).delete()));
      return Promise.all(ops);
    });
  }
  Promise.all([deleteAll(ACTIVE), deleteAll(DEPARTED)])
    .catch(function(err){ console.error('Clear failed',err); alert('Clear failed. Check permissions.'); });
}

/* ---------------- Handlers (no spacebar adds) ---------------- */
addBtn.addEventListener('click', function(){
  if(!isAdmin()) return alert('Unlock admin first');
  warmAudioOnce();
  addFromStringCloud(busInput.value);
});
busInput.addEventListener('keydown', function(e){
  if(!isAdmin()) return;
  if(e.key==='Enter' || e.key===','){
    e.preventDefault();
    warmAudioOnce();
    addFromStringCloud(busInput.value);
  }
});
busInput.addEventListener('input', function(){
  if(!isAdmin()) return;
  const v = busInput.value;
  if(v.endsWith(',') && v.trim().length>1){
    warmAudioOnce();
    addFromStringCloud(v.slice(0,-1));
    busInput.value='';
  }
});

// Delegated remove
document.addEventListener('click', async function(e){
  const t = e.target;
  if(!t || !t.hasAttribute('data-doc')) return;
  if(!isAdmin()) return alert('Unlock admin first');

  const docId = t.getAttribute('data-doc');
  const label = decodeURIComponent(t.getAttribute('data-label')||'');
  try{
    await departByDocId(docId);
  }catch(_){
    // Fallbacks if direct doc deletion fails for any reason
    await departByLookup(label);
  }
});

clearAllBtn.addEventListener('click', function(){
  if(!isAdmin()) return alert('Unlock admin first');
  if(confirm('Clear all entries and departed?')) clearAllCloud();
});
</script>
</body>
</html>
