<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WCMS Bus Dismissal Board â€” Cloud Sync</title>
<style>
:root{--bg:#344e41;--panel:#3a5a40;--btn:#588157;--accent:#a3b18a;--text:#dad7cd;--bd:#274033;--tile:#2f4639}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#2f4639;border-bottom:1px solid var(--bd)}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.chip{padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#2c4437;opacity:.95;font-size:12px;cursor:default}
.chip.btn{cursor:pointer;user-select:none}
.container{max-width:1200px;margin:18px auto;padding:0 16px}
.layout{display:grid;grid-template-columns:1fr 320px;gap:16px}
@media (max-width:900px){.layout{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:16px;padding:14px;box-shadow:0 8px 24px #0005}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
.bus{position:relative;background:var(--tile);border:1px solid var(--bd);border-radius:14px;padding:24px 14px;text-align:center;font-weight:900;font-size:32px}
.inline-btn{position:absolute;top:8px;right:8px;font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--bd);background:var(--panel);color:var(--text);cursor:pointer}
.departed-item{background:var(--tile);border:1px solid var(--bd);border-radius:12px;padding:8px 10px;margin-top:8px;display:flex;justify-content:space-between}
input{background:#263b30;color:var(--text);border:1px solid var(--bd);border-radius:12px;padding:10px 12px;outline:none;min-width:260px}
button{cursor:pointer;font-weight:800;border-radius:12px;padding:10px 14px;border:1px solid var(--bd);background:var(--btn);color:var(--text)}
button.secondary{background:var(--accent);color:#263326}
.muted{opacity:.85;font-size:12px}
.hidden{display:none}

/* Sound gate */
#soundGate{
  position:fixed;inset:0;z-index:1000;background:linear-gradient(180deg,#2b3f34 0%,#344e41 100%);
  display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;
  padding:24px;cursor:pointer;transition:opacity .25s ease;
}
#soundGate.hidden{opacity:0;pointer-events:none}
#soundGate .card{
  background:#263b30;border:1px solid var(--bd);border-radius:16px;max-width:560px;width:min(92%,560px);
  padding:24px 20px;box-shadow:0 12px 40px #0007;
}
#soundGate h1{margin:0 0 8px 0;font-size:26px}
#soundGate p{margin:6px 0 14px 0;opacity:.95}
#soundGate .tapHint{opacity:.8;font-size:13px}
#soundGate .gateBtn{margin-top:12px;padding:12px 16px;border-radius:12px;border:1px solid var(--bd);background:var(--btn);color:var(--text);font-weight:900;font-size:16px;}
#testChime{display:none;margin:10px 0 0 0}
</style>
</head>
<body>
<!-- Sound gate overlay -->
<div id="soundGate" role="button" aria-label="Tap to enable announcements"
     onclick="window.__enableSoundNow && window.__enableSoundNow()">
  <div class="card">
    <h1>ðŸ”Š Enable Bus Announcements</h1>
    <p>This page will chime and read numbers aloud. Tap to allow sound on this device.</p>
    <button class="gateBtn" id="gateBtn"
            onclick="event.stopPropagation();window.__enableSoundNow && window.__enableSoundNow()">Enable Sound</button>
    <button id="testChime" class="gateBtn"
            onclick="event.stopPropagation();window.__testChime && window.__testChime()">Test Chime</button>
    <div class="tapHint">Tip: Youâ€™ll only need to do this once per device per day.</div>
  </div>
</div>

<header>
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 13h18v3a5 5 0 0 1-5 5H8a5 5 0 0 1-5-5v-3Z" stroke="#a3b18a" stroke-width="1.5"/><path d="M5 9.5h14a2 2 0 0 1 2 2V13H3v-1.5a2 2 0 0 1 2-2Z" fill="#2f4639" stroke="#a3b18a" stroke-width="1.5"/><circle cx="7" cy="18.5" r="1.7" fill="#a3b18a"/><circle cx="17" cy="18.5" r="1.7" fill="#a3b18a"/></svg>
    <span>WCMS Bus Dismissal Board</span>
  </div>
  <div class="row">
    <span id="syncBadge" class="chip">Sync: Cloud</span>
    <span id="adminStatus" class="chip">Viewer</span>
    <span id="quietChip" class="chip btn" title="Toggle announcements (mute/unmute)">ðŸ”‡ Quiet Mode: Off</span>
    <button id="adminLoginBtn" class="secondary">Admin Login</button>
  </div>
</header>

<div class="container">
  <div id="adminPanel" class="panel hidden" aria-live="polite">
    <div class="row" style="justify-content:space-between;width:100%">
      <strong>Admin Controls</strong>
      <div class="row">
        <span id="sessionTimeLeft" class="chip">Admin: --</span>
        <button id="lockBtn">Lock Now</button>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="busInput" placeholder="Type entries separated by commas (e.g., 102, Car & Van, 62/65, A/B)" />
      <button id="addBtn">Add to Board</button>
      <button id="clearAllBtn">Clear All</button>
    </div>
    <div class="muted">Accepts words & symbols (/, &, -). Newest on top. Chime + voice on add & depart.</div>
  </div>

  <div class="layout">
    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Now Boarding</h2>
        <span class="muted" id="liveMeta">Cloud Firestore</span>
      </div>
      <div id="board" class="grid" aria-live="assertive"></div>
    </div>
    <aside class="panel" aria-live="polite">
      <h3 style="margin:0 0 8px 0">Departed</h3>
      <div id="departedList"></div>
    </aside>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>

<script>
/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAOFY5GUONFgaorwLfaCE7imj5NbN0NN0U",
  authDomain: "wcms-bus-board.firebaseapp.com",
  projectId: "wcms-bus-board",
  storageBucket: "wcms-bus-board.firebasestorage.app",
  messagingSenderId: "302977263459",
  appId: "1:302977263459:web:cd3aaf4a1ff3fca36b1556",
  measurementId: "G-TP5DSZS0X2"
};
let db=null;
try{ const app=firebase.initializeApp(firebaseConfig); db=firebase.firestore(); }
catch(e){ console.error("Firebase init failed:", e); alert("Couldn't connect to Firebase."); }

/* ===== Audio + Announcement Controls ===== */
let audioEnabled=false,preferredVoice=null,audioCtx=null;
let audioMuted=false;                       // manual mute (Quiet Mode)
let bulkMuteCounter=0;                      // auto-mute during bulk ops
let speakQueue=[]; let speakBusy=false;
const quietChip=document.getElementById('quietChip');

function isAudioAllowed(){ return audioEnabled && !audioMuted && bulkMuteCounter===0; }
function setQuietMode(on){
  audioMuted = !!on;
  quietChip.textContent = audioMuted ? "ðŸ”‡ Quiet Mode: On" : "ðŸ”Š Quiet Mode: Off";
}
quietChip.addEventListener('click', ()=> setQuietMode(!audioMuted));
function bulkMute(on){ bulkMuteCounter = Math.max(0, bulkMuteCounter + (on?1:-1)); }

function getVoicesSafe(){try{const v=window.speechSynthesis?window.speechSynthesis.getVoices():[];return Array.isArray(v)?v:[];}catch{return[];}}
function pickVoice(){const voices=getVoicesSafe();const prefs=["en-US","en_US","en-GB","en_GB"];let best=null;for(const p of prefs){const f=voices.find(v=>(v.lang||"").toLowerCase()===p.toLowerCase());if(f){best=f;break;}}preferredVoice=best||voices[0]||null;}
function waitForVoices(t=3000){return new Promise(r=>{if(!('speechSynthesis'in window))return r(false);if(getVoicesSafe().length)return r(true);let done=false;const timer=setTimeout(()=>{if(!done){done=true;r(getVoicesSafe().length>0);}},t);window.speechSynthesis.onvoiceschanged=()=>{if(done)return;done=true;clearTimeout(timer);r(getVoicesSafe().length>0);};});}
async function unlockAudioContext(){ const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return false; if(!audioCtx) audioCtx=new Ctx(); if(audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} } try{ const buffer=audioCtx.createBuffer(1,1,22050); const src=audioCtx.createBufferSource(); src.buffer=buffer; src.connect(audioCtx.destination); src.start(0);}catch{} return audioCtx.state==='running'; }
function hideGate(){ const gate=document.getElementById('soundGate'); if(!gate) return; gate.classList.add('hidden'); setTimeout(()=>{ if(gate) gate.style.display='none'; }, 260); }
async function enableSoundNow(){ try{ hideGate(); audioEnabled=true; await unlockAudioContext(); await waitForVoices(2500); pickVoice(); const t=document.getElementById('testChime'); if(t) t.style.display='inline-block'; if('speechSynthesis'in window){ try{ window.speechSynthesis.cancel(); window.speechSynthesis.resume(); const u=new SpeechSynthesisUtterance(" "); u.volume=0; u.lang="en-US"; if(preferredVoice)u.voice=preferredVoice; window.speechSynthesis.speak(u);}catch{} } }catch(e){ console.error('Sound enable error:', e); } }
window.__enableSoundNow = enableSoundNow;
window.__testChime = ()=> chime(880,1320,1.0,0.8);

function speakify(label){ let t=String(label); return t.replace(/\//g,' slash ').replace(/&/g,' and ').replace(/-/g,' dash ').replace(/\+/g,' plus ').replace(/\s+/g,' ').trim(); }
async function chime(f1,f2,v,d){ if(!isAudioAllowed()) return; try{ await unlockAudioContext(); const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator(),g=audioCtx.createGain(); o1.type='triangle'; o2.type='sine'; o1.frequency.setValueAtTime(f1,audioCtx.currentTime); o2.frequency.setValueAtTime(f2,audioCtx.currentTime); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(v,audioCtx.currentTime+0.03); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+d); o1.connect(g); o2.connect(g); g.connect(audioCtx.destination); o1.start(); o2.start(); o1.stop(audioCtx.currentTime+d); o2.stop(audioCtx.currentTime+d); }catch{} }
function speakNow(text){ if(!isAudioAllowed() || !('speechSynthesis' in window)) return; try{ window.speechSynthesis.cancel(); window.speechSynthesis.resume(); const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; if(preferredVoice)u.voice=preferredVoice; window.speechSynthesis.speak(u);}catch{} }
function enqueueSpeak(text){ speakQueue.push(text); drainSpeakQueue(); }
function drainSpeakQueue(){ if(speakBusy || !isAudioAllowed()) return; const next = speakQueue.shift(); if(!next) return; speakBusy=true; chime(1046.5,1568.0,1.0,1.2); setTimeout(()=>{ speakNow(next); setTimeout(()=>{ speakBusy=false; drainSpeakQueue(); }, 1200); }, 180); }

/* ===== Admin (Auth + local 1h unlock) ===== */
var adminPanel=document.getElementById('adminPanel'),
    adminStatus=document.getElementById('adminStatus'),
    adminLoginBtn=document.getElementById('adminLoginBtn'),
    lockBtn=document.getElementById('lockBtn'),
    sessionTimeLeft=document.getElementById('sessionTimeLeft');

function isAdmin(){ var v=localStorage.getItem('bus_admin_until'); return v && Number(v)>Date.now(); }
function setAdminFor1Hour(){ var until=Date.now()+3600000; localStorage.setItem('bus_admin_until', String(until)); updateAdminUI(); }
function clearAdmin(){ localStorage.removeItem('bus_admin_until'); updateAdminUI(); }
function updateAdminUI(){ var a=isAdmin(); adminPanel.classList.toggle('hidden', !a); adminLoginBtn.classList.toggle('hidden', a); adminStatus.textContent = a ? 'Admin' : 'Viewer'; }
adminLoginBtn.addEventListener('click', async ()=>{
  const email = prompt('Admin email:'); if(!email) return;
  const pass  = prompt('Password:');    if(!pass) return;
  try{ await firebase.auth().signInWithEmailAndPassword(email, pass); setAdminFor1Hour(); alert('Admin unlocked.'); }
  catch(e){ alert('Sign-in failed: ' + (e && e.message ? e.message : e)); }
});
lockBtn && lockBtn.addEventListener('click', clearAdmin);
setInterval(function(){
  var v=localStorage.getItem('bus_admin_until');
  if(!v){ sessionTimeLeft.textContent='Locked'; return; }
  var ms=Number(v)-Date.now();
  if(ms<=0){ clearAdmin(); sessionTimeLeft.textContent='Locked'; return; }
  var m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000);
  sessionTimeLeft.textContent='Admin: '+m+'m '+s+'s';
},1000);
updateAdminUI();
// Reflect signed-in user
if(firebase && firebase.auth){
  firebase.auth().onAuthStateChanged(u=>{
    if(u && u.email){ adminStatus.textContent='Admin ('+u.email+')'; }
    else { adminStatus.textContent='Viewer'; }
  });
}

/* ===== Firestore Collections & UI ===== */
const ACTIVE='wcms_bus_board', DEPARTED='wcms_bus_departed';
var board=document.getElementById('board'),
    departedList=document.getElementById('departedList'),
    busInput=document.getElementById('busInput'),
    addBtn=document.getElementById('addBtn'),
    clearAllBtn=document.getElementById('clearAllBtn'),
    liveMeta=document.getElementById('liveMeta');

function makeActiveTile(id,label){
  const wrap=document.createElement('div'); wrap.className='bus';
  const btn=document.createElement('button'); btn.className='inline-btn';
  btn.setAttribute('data-doc', id); btn.setAttribute('data-label', encodeURIComponent(label));
  btn.textContent='Remove'; wrap.appendChild(btn);
  wrap.appendChild(document.createTextNode(label));
  return wrap;
}
function renderActive(items){ board.innerHTML=''; items.forEach(it=> board.appendChild(makeActiveTile(it.id,it.display))); }
function renderDeparted(items){
  departedList.innerHTML=''; items.forEach(n=>{
    const e=document.createElement('div'); e.className='departed-item'; e.textContent=n; departedList.appendChild(e);
  });
}

let activeLoaded=false, departedLoaded=false;
if(db){
  db.collection(ACTIVE).onSnapshot(function(snap){
    liveMeta.textContent='Cloud Firestore Â· '+snap.size+' entries';
    const list = snap.docs.map(d=>{
      const data=d.data()||{};
      return { id:d.id, display:data.number ?? d.id, orderMs: typeof data.orderMs==='number'?data.orderMs:0 };
    }).sort((a,b)=> b.orderMs - a.orderMs);
    renderActive(list);

    if(!activeLoaded){ activeLoaded=true; return; }
    const added = snap.docChanges().filter(c=>c.type==='added').map(c=> (c.doc.data().number ?? c.doc.id));
    if(added.length){ const spoken = added.map(s=>speakify(s)).join(', '); enqueueSpeak('Bus '+spoken+' now boarding'); }
  });

  db.collection(DEPARTED).onSnapshot(function(snap){
    const list = snap.docs.map(d=>{
      const data=d.data()||{};
      return { display:data.number ?? d.id, orderMs: typeof data.departOrderMs==='number'?data.departOrderMs:0 };
    }).sort((a,b)=> b.orderMs - a.orderMs);
    renderDeparted(list.map(x=>x.display));

    if(!departedLoaded){ departedLoaded=true; return; }
    const added = snap.docChanges().filter(c=>c.type==='added').map(c=> (c.doc.data().number ?? c.doc.id));
    if(added.length){ const spoken = added.map(s=>speakify(s)).join(', '); // different chime for depart
      if(isAudioAllowed()){ chime(659.25,440.0,0.9,0.8); setTimeout(()=> speakNow('Bus '+spoken+' has departed'), 120); }
    }
  });
}

/* ===== Helpers ===== */
function tokenize(input){ return String(input||'').split(',').map(s=>s.trim()).filter(Boolean); }
function toKey(s){ return s.trim().toLowerCase(); }

/* ===== Adds ===== */
async function addFromStringCloud(str){
  const tokens = tokenize(str); if(!tokens.length) return;
  const ops = []; let base = Date.now();
  for(let i=0;i<tokens.length;i++){
    const display = tokens[i]; const key = toKey(display);
    const snap = await db.collection(ACTIVE).where('numberLower','==',key).limit(1).get();
    if(snap.empty){
      const orderMs = base + i;
      ops.push( db.collection(ACTIVE).add({
        number: display, numberLower: key, orderMs,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtClient: orderMs
      }));
    }
  }
  if(ops.length){
    try{ await Promise.all(ops); }catch(e){
      console.error('Add failed',e);
      alert('Add failed. Are you signed in with an admin email and do rules allow writes?');
    }
  }
  busInput.value='';
}

/* ===== Depart / Remove ===== */
async function moveDocToDepartedAndDelete(ref){
  const now = Date.now();
  await db.runTransaction(async tx=>{
    const snap = await tx.get(ref);
    if(!snap.exists) return;
    const data = snap.data() || {};
    const label = data.number ?? snap.id;
    tx.set(db.collection(DEPARTED).doc(label+'-'+now), {
      number: label, departOrderMs: now,
      departedAt: firebase.firestore.FieldValue.serverTimestamp(),
      departedAtClient: now
    });
    tx.delete(ref);
  });
}
async function departByDocId(docId){ const ref = db.collection(ACTIVE).doc(docId); await moveDocToDepartedAndDelete(ref); }
async function departByLookup(label){
  const key = toKey(label);
  let qs = await db.collection(ACTIVE).where('numberLower','==',key).limit(5).get();
  if(qs.empty){ qs = await db.collection(ACTIVE).where('number','==',label).limit(5).get(); }
  if(qs.empty){
    const ref = db.collection(ACTIVE).doc(label); // legacy id fallback
    try{ await moveDocToDepartedAndDelete(ref); }catch(e){}
    return;
  }
  const ops=[]; qs.forEach(d=> ops.push(moveDocToDepartedAndDelete(db.collection(ACTIVE).doc(d.id)))); await Promise.all(ops);
}

/* ===== Paged, Batched Clear (auto-muted) ===== */
async function deleteCollectionPaged(collPath, batchSize=300){
  let total = 0;
  while(true){
    const snap = await db.collection(collPath)
      .orderBy(firebase.firestore.FieldPath.documentId())
      .limit(batchSize)
      .get();

    if (snap.empty) break;

    const batch = db.batch();
    snap.docs.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    total += snap.size;

    await new Promise(r=>setTimeout(r,40));
  }
  return total;
}

async function clearAllCloud(){
  if(!isAdmin()){
    alert('Unlock admin first (Admin Login). You must be signed in with an admin email.');
    return;
  }
  if(!confirm('Clear ALL current and departed entries? This cannot be undone.')) return;

  clearAllBtn.disabled = true;
  clearAllBtn.textContent = 'Clearing...';

  bulkMute(true);           // ðŸ”‡ auto-mute announcements during the whole clear
  const prevMuted = audioMuted; setQuietMode(true);

  try{
    const [aCount, dCount] = await Promise.all([
      deleteCollectionPaged(ACTIVE, 400),
      deleteCollectionPaged(DEPARTED, 400),
    ]);
    alert(`Cleared ${aCount} active + ${dCount} departed entries.`);
  }catch(e){
    console.error('Clear failed', e);
    const msg = (e && e.message) ? e.message : String(e);
    if (/PERMISSION_DENIED|Missing or insufficient permissions/i.test(msg)) {
      alert('Clear failed: permissions. Make sure:\nâ€¢ You used Admin Login (Firebase Auth)\nâ€¢ Your Firestore rules allow admin deletes\nâ€¢ Your site domain is in Auth > Settings > Authorized domains');
    } else {
      alert('Clear failed: '+ msg);
    }
  }finally{
    clearAllBtn.disabled = false;
    clearAllBtn.textContent = 'Clear All';
    bulkMute(false);        // release auto-mute
    setQuietMode(prevMuted);// restore manual mute state
  }
}

/* ===== Handlers ===== */
document.getElementById('addBtn').addEventListener('click', function(){
  if(!isAdmin()) return alert('Unlock admin first');
  addFromStringCloud(busInput.value);
});
busInput.addEventListener('keydown', function(e){
  if(!isAdmin()) return;
  if(e.key==='Enter' || e.key===','){ e.preventDefault(); addFromStringCloud(busInput.value); }
});
busInput.addEventListener('input', function(){
  if(!isAdmin()) return;
  const v = busInput.value;
  if(v.endsWith(',') && v.trim().length>1){ addFromStringCloud(v.slice(0,-1)); busInput.value=''; }
});
document.addEventListener('click', async function(e){
  const t=e.target; if(!t || !t.hasAttribute('data-doc')) return;
  if(!isAdmin()) return alert('Unlock admin first');
  const docId=t.getAttribute('data-doc'); const label=decodeURIComponent(t.getAttribute('data-label')||'');
  try{ await departByDocId(docId); }catch(_){ await departByLookup(label); }
});
document.getElementById('clearAllBtn').addEventListener('click', clearAllCloud);

// Also bind after DOM ready just in case
document.addEventListener('DOMContentLoaded', ()=> {
  const g=document.getElementById('soundGate');
  const b=document.getElementById('gateBtn');
  if(g) g.addEventListener('click', enableSoundNow, {once:true});
  if(b) b.addEventListener('click', (e)=>{e.stopPropagation(); enableSoundNow();}, {once:true});
});
</script>
</body>
</html>
